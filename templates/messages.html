<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - Admin</title>
    <link href="{{ url_for('static', filename='css/admin.css') }}" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

</head>
<body>
    <header>
        <div class="logo">
            <img src="{{ url_for('static', filename='img/insightify.JPG') }}" alt="Insightify Logo"/>
        </div>
        <h1>Admin Dashboard</h1>

        <div class="notification" onclick="window.location.href='{{ url_for('admin.admin_contact') }}'">
            <i class="fas fa-bell"></i>
            {% if unread_count > 0 %}
            <span class="badge">{{ unread_count }}</span>
            {% endif %}
        </div>
        
        
        <button id="logoutBtn">Logout</button>

        
    </header>

    <nav>
        <ul>
            <li><a href="/admin/admin_dashboard" class="active">Dashboard</a></li>
            <li><a href="/admin/users">Registered Users</a></li>
            <li><a href="#">Test Results</a></li>
            <li><a href="/admin/doctors">Doctor Recommendations</a></li>
            <li><a href="/admin/messages">Messages</a></li>
        </ul>
    </nav>

    <main>
        <h2>Manage User Messages</h2>

        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Message</th>
                    <th>Reply</th>
                    <th>Date Sent</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Loop through messages passed from Flask -->
                {% for message in messages %}
                <tr>
                    <td>{{ message.id }}</td>
                    <td>{{ message.name }}</td>
                    <td>{{ message.email }}</td>
                    <td>{{ message.content }}</td>
                    <td>{{ message.reply if message.reply else 'No reply yet' }}</td>
                    <td>{{ message.date_sent }}</td>
                    <td>
                        <button class="reply-btn" onclick="replyMessage({{ message.id }})">Reply</button>
                        <button class="delete-btn" onclick="deleteMessage({{ message.id }})">Delete</button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6">No messages found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </main>

    <script>
        function logout() {
            alert("Logging out...");
            window.location.href = "admin_login.html"; // Redirect to login page after logout
        }

        function replyMessage(messageId) {
            // Handle the reply functionality
            alert("Replying to message ID: " + messageId);
            // You can implement the reply feature here
        }

        async function deleteMessage(messageId) {
            if (confirm("Are you sure you want to delete this message?")) {
                try {
                    const response = await fetch(`/admin/delete-message/${messageId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                    });

                    const result = await response.json();
                    if (result.success) {
                        alert("Message deleted successfully!");
                        window.location.reload(); // Refresh the list
                    } else {
                        alert("Failed to delete message.");
                    }
                } catch (error) {
                    console.error("Delete error:", error);
                }
            }
        }

        function replyMessage(messageId) {
    const reply = prompt("Enter your reply:");
    if (reply) {
        fetch(`/admin/reply-message/${messageId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ reply: reply })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("Reply sent successfully!");
                window.location.reload();
            } else {
                alert("Failed to send reply.");
            }
        })
        .catch(error => {
            console.error("Error sending reply:", error);
        });
    }
}

function deleteMessage(messageId) {
        if (confirm("Are you sure you want to delete this message?")) {
            fetch(`/admin/delete-message/${messageId}`, {
                method: 'DELETE',
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                if (data.success) {
                    location.reload(); // Refresh the page to show updated list
                }
            })
            .catch(error => {
                console.error('Error deleting message:', error);
                alert('Failed to delete the message.');
            });
        }
    }
    </script>
</body>
</html>
